<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm viewport để tối ưu hóa di động -->
    <title>越南语听力练习</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 0; 
            padding-bottom: 300px; /* Mặc định cho màn hình lớn */
            background-color: #f7fbf3; /*f7fbf3  3f4040*/
        }
        #gameContainer {
            display: block;
            min-height: calc(100vh - 150px); /* Đảm bảo nội dung chiếm đủ chiều cao màn hình */
        }
        #infoBox { 
            width: 95%; 
            max-width: 700px;
            min-height: 100px; 
            margin: 0 auto; 
            border: 2px solid #91b66f; /*041b31 1f4263*/
            background: #85ae5f; /*ecf2e4 fefefc*/
            color: #ffffff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        #contactBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #91b66f; 
            background: #85ae5f; 
            color: #f1c232; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #instructionBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #91b66f; 
            background: #85ae5f; 
            color: #f7e19c; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #controls { 
            position: fixed; /* Cố định ở cuối màn hình */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px; /* Giới hạn chiều rộng tối đa */
            background: #f7fbf3;
                        border: 3px solid #f7fbf3;                        
            padding: 10px 0; 
           /* box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); */
            z-index: 1000; 
        }
        #controls div {
            margin: 5px 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button { 
            padding: 8px 8px; 
            margin: 0 5px; 
            cursor: pointer; 
            border: 2px solid #85ae5f; 
            background: #85ae5f; /*192332*/
                        box-shadow: 0 5px 5px rgba(0, 0, 0, 0.2);
            color: #fffbef; 
            font-size: 28px; 
            border-radius: 5px; 
        }
        #sentenceNumber { 
            width: 50px; 
            padding: 10px; 
            text-align: center; 
            border: 3px solid #85ae5f; /*041b31 68838B*/
            background: #f1cc76; 
            color: #000; 
            border-radius: 10px; 
            font-size: 16px; 
            -moz-appearance: textfield; 
        }
        #sentenceNumber::-webkit-inner-spin-button, 
        #sentenceNumber::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        #sentenceNumber:disabled { 
            background: #eee; 
        }
        .disabled { 
            cursor: not-allowed; 
            pointer-events: none; 
        }
        .active-mode { 
            border: 2px solid #fed16a; 
        }
        #indicator { 
            width: 95%;
                        max-width: 700px; 
            min-height: 50px; 
            margin: 10px auto; 
                        padding: 5px;
            border: 3px solid #fed16a; 
            background: #ffffe0; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        #optionsContainer {
            width: 100%;
            max-width: 700px;
            margin: 10px auto;
        }
        .optionBtn {
            width: 95%; 
            max-width: 700px;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #ffffff;
            background: #ffffff; /*E6EDD9*/
            color: #000000;
                        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 30px;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
        }
        .optionBtn:hover {
            background: #D2E4C4;
        }
        .correct {
            background: #B7D7AA !important;
        }
        .wrong {
            background: #CE6D5E !important;
        }
        #score { 
            display: none; 
            width: 100%;
            max-width: 700px;
            margin: 10px auto; 
            color: #FF6820; 
            font-size: 30px; 
            text-align: center;
        }
        #wrongSentences { 
            display: none; 
            width: 95%; 
            max-width: 700px; 
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #CE6D5E; 
            background: #FFF0F0; 
            color: #CE6D5E; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
        }
        #results { 
            display: none; 
            width: 95%;
            max-width: 700px;        
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #734A2E; 
            background: #fffbef; 
            color: #000; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
            white-space: pre-line;
        }

        /* Media query cho thiết bị di động */
        @media (max-width: 768px) {
            body {
                padding-bottom: 200px; /* Giảm padding-bottom cho điện thoại */
            }
            #controls {
                padding: 5px 0; /* Giảm padding */
            }
            button {
                padding: 6px 6px; /* Giảm kích thước nút */
                font-size: 20px; /* Giảm kích thước chữ */
            }
            #sentenceNumber {
                width: 40px; /* Giảm chiều rộng */
                padding: 8px; /* Giảm padding */
                font-size: 14px; /* Giảm kích thước chữ */
            }
            .optionBtn {
                font-size: 20px; /* Giảm kích thước chữ cho đáp án */
                padding: 8px; /* Giảm padding */
            }
            #infoBox {
                font-size: clamp(30px, 4vw, 40px); /* Giảm kích thước chữ */
            }
            #contactBox, #instructionBox {
                font-size: clamp(14px, 2vw, 16px); /* Giảm kích thước chữ */
            }
            #indicator {
                min-height: 40px; /* Giảm chiều cao tối thiểu */
            }
            #results, #wrongSentences, #score {
                font-size: 24px; /* Giảm kích thước chữ */
                                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>听力练习</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">选择与播放内容相符的选项</div>
        <div id="indicator"></div>
        <div id="optionsContainer"></div>
        <div id="results"></div>
        <div id="score">0/0</div>
        <div id="wrongSentences"></div>
    </div>
    <div id="controls">
        <div>
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
        </div>
        <div>
            <button id="autoContinueBtn">自动继续</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div>
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric" pattern="[0-9]*">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>
    <audio id="mainAudio" src="audio.mp3"></audio>
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>
        const audio = document.getElementById('mainAudio');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');
        const indicator = document.getElementById('indicator');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const replayBtn = document.getElementById('replayBtn');
        const freeModeBtn = document.getElementById('freeModeBtn');
        const testModeBtn = document.getElementById('testModeBtn');
        const autoContinueBtn = document.getElementById('autoContinueBtn');
        const showHideBtn = document.getElementById('showHideBtn');
        const scoreDisplay = document.getElementById('score');
        const wrongSentencesDisplay = document.getElementById('wrongSentences');
        const optionsContainer = document.getElementById('optionsContainer');
        const resultsDisplay = document.getElementById('results');

        const buttons = [prevBtn, nextBtn, replayBtn, freeModeBtn, testModeBtn, autoContinueBtn, showHideBtn];

const sentences = [
    {
        "audioFile": "audio1.mp3",
        "start": 0.003528,
        "end": 0.065464,
        "correctAnswer": "谁",
        "translation": "疑问代词 ai 是什么意思？",
        "options": [
            "谁",
            "什么",
            "怎么样"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 0.30525,
        "end": 1.67525,
        "correctAnswer": "Anh là ai?",
        "translation": "你是谁？",
        "options": [
            "Anh là ai?",
            "Anh là ải?",
            "Oanh là ai?",
            "Anh là ay?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 2.22525,
        "end": 3.65525,
        "correctAnswer": "Tôi là Ba.",
        "translation": "我是巴。",
        "options": [
            "Tôi là Ba.",
            "Tôi là Bà.",
            "Tơi là Ba.",
            "Tôi là Pa."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 4.20525,
        "end": 5.90525,
        "correctAnswer": "Anh ấy là ai?",
        "translation": "他是谁？",
        "options": [
            "Anh ấy là ai?",
            "Anh ấy là ái?",
            "Oanh ấy là ai?",
            "Anh ấy là ay?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 6.37525,
        "end": 8.31525,
        "correctAnswer": "Anh ấy là anh Kim.",
        "translation": "他是金哥。",
        "options": [
            "Anh ấy là anh Kim.",
            "Anh ấy là anh Kinh.",
            "Anh ấy là anh Kìm.",
            "Anh ấy là oanh Kim."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 9.12525,
        "end": 10.54525,
        "correctAnswer": "Chị là ai?",
        "translation": "姐姐是谁？",
        "options": [
            "Chị là ai?",
            "Chị là ải?",
            "Dị là ai?",
            "Chị là ay?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 11.16525,
        "end": 12.56525,
        "correctAnswer": "Tôi là Vy.",
        "translation": "我是(阿)薇。",
        "options": [
            "Tôi là Vy.",
            "Tơi là Phi.",
            "Tơi là Vy.",
            "Tôi là Phi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 13.38525,
        "end": 14.80525,
        "correctAnswer": "Ai là An.",
        "translation": "谁是(阿)安？",
        "options": [
            "Ai là An?",
            "Ai là Ẩn?",
            "Ai là Anh?",
            "Ai là Am?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 15.54525,
        "end": 16.91525,
        "correctAnswer": "Tôi là An.",
        "translation": "我是(阿)安。",
        "options": [
            "Tôi là An.",
            "Tôi là Ân.",
            "Tơi là An.",
            "Tôi là Am."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 17.59525,
        "end": 19.09525,
        "correctAnswer": "Đây là ai?",
        "translation": "这是谁？",
        "options": [
            "Đây là ai?",
            "Đây là ải?",
            "Đây là ay?",
            "Dây là ai?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 19.87525,
        "end": 21.48525,
        "correctAnswer": "Đây là cô Lan.",
        "translation": "这是(阿)兰老师。",
        "options": [
            "Đây là cô Lan.",
            "Đây là cô Lăn.",
            "Đây là cô Len.",
            "Đây là cô Nan."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 22.37525,
        "end": 23.93525,
        "correctAnswer": "Đấy là ai?",
        "translation": "那是谁？",
        "options": [
            "Đấy là ai?",
            "Đấy là ay?",
            "Đấy là ải?",
            "Dấy là ai?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 24.68525,
        "end": 26.48525,
        "correctAnswer": "Đấy là chị Nga.",
        "translation": "那是(阿)娥姐姐。",
        "options": [
            "Đấy là chị Nga.",
            "Đấy là chị Nha.",
            "Đấy là chị Ngà.",
            "Đấy là dị Nga."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 27.23525,
        "end": 28.81525,
        "correctAnswer": "Đó là ai?",
        "translation": "那是谁？",
        "options": [
            "Đó là ai?",
            "Đó là ải?",
            "Đó là ay?",
            "Đó là ai"
        ]
    },
    {
        "audioFile": "audio1.mp3",
        "start": 0.003528,
        "end": 0.065464,
        "correctAnswer": "强调所说的话",
        "translation": "指示代词 đấy 是“那”的意思，语气助词 đấy 又有什么作用呢？ ",
        "options": [
            "强调所说的话",
            "表示疑问语气",
            "表示感叹语气"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 29.48525,
        "end": 31.41525,
        "correctAnswer": "Đó là bà Hà đấy.",
        "translation": "那是(阿)霞奶奶。",
        "options": [
            "Đó là bà Hà đấy.",
            "Đó là bà Hạ đấy.",
            "Đó là bà Há đấy.",
            "Đó là bà Hả đấy."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 32.30525,
        "end": 33.69525,
        "correctAnswer": "Kia là ai?",
        "translation": "那边的是谁？",
        "options": [
            "Kia là ai?",
            "Kia là ái?",
            "Kia là ai",
            "Kía là ai?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 34.34525,
        "end": 36.32525,
        "correctAnswer": "Đó là anh Tư đấy.",
        "translation": "那是(阿)思哥。",
        "options": [
            "Đó là anh Tư đấy.",
            "Đó là anh Tú đấy.",
            "Đó là anh Thư đấy.",
            "Đó là anh Tứ đấy."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 37.27525,
        "end": 39.14525,
        "correctAnswer": "Ai là người Trung Quốc.",
        "translation": "谁是中国人？",
        "options": [
            "Ai là người Trung Quốc?",
            "Ai là người Trung Cuốc?",
            "Ai là người Trung Quấc?",
            "Ai là người Trưng Quốc?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 39.81525,
        "end": 41.76525,
        "correctAnswer": "Tôi là người Trung Quốc.",
        "translation": "我是中国人。",
        "options": [
            "Tôi là người Trung Quốc.",
            "Tôi là người Trung Cuốc.",
            "Tơi là người Trung Quốc.",
            "Tôi là người Trưng Quốc."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 42.64525,
        "end": 45.17525,
        "correctAnswer": "Anh ấy cũng là người Trung Quốc.",
        "translation": "他也是中国人。",
        "options": [
            "Anh ấy cũng là người Trung Quốc.",
            "Anh ấy củng là người Trung Quốc.",
            "Oanh ấy cũng là người Trung Quốc.",
            "Anh ấy cũng là người Trung Cuốc."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 45.95525,
        "end": 48.54525,
        "correctAnswer": "Chúng tôi đều là người Trung Quốc.",
        "translation": "我们都是中国人。",
        "options": [
            "Chúng tôi đều là người Trung Quốc.",
            "Chúng tôi đều là người Trung Cuốc.",
            "Chúng tôi đều là người Trung Quấc.",
            "Chúng tôi điêu là người Trung Quốc."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 49.35525,
        "end": 50.97525,
        "correctAnswer": "Cô ấy thế nào?",
        "translation": "她怎么样？",
        "options": [
            "Cô ấy thề nào?",
            "Cô ẩy thế nào?",
            "Cô ấy thế náo?",
            "Cô ấy thế nào?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 51.66525,
        "end": 53.13525,
        "correctAnswer": "Cô ấy rất đẹp.",
        "translation": "她很漂亮。",
        "options": [
            "Cô ấy rát đẹp.",
            "Cô ẩy rất đẹp.",
            "Cô ấy rất đẹt.",
            "Cô ấy rất đẹp."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 53.89525,
        "end": 56.01525,
        "correctAnswer": "Anh ấy có đẹp trai không?",
        "translation": "他帅吗？",
        "options": [
            "Anh ấy co đẹp trai không?",
            "Anh ẩy có đẹp trai khôn?",
            "Anh ấy có đẹp chai không?",
            "Anh ấy có đẹp trai không?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 56.71525,
        "end": 58.91525,
        "correctAnswer": "Anh ấy rất đẹp trai đấy.",
        "translation": "他真的很帅呢。",
        "options": [
            "Anh ấy rất đep trai đấy.",
            "Anh ấy rất đẹp tray đấy.",
            "Anh ẩy rất đẹp trai đấy.",
            "Anh ấy rất đẹp trai đấy."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 59.72525,
        "end": 61.28525,
        "correctAnswer": "Ông ấy thế nào?",
        "translation": "他（老先生）怎么样？",
        "options": [
            "Ông ấy thề nào?",
            "Ông ấy thế náo?",
            "Ông ẩy thế nào?",
            "Ông ấy thế nào?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 61.83525,
        "end": 63.34525,
        "correctAnswer": "Ông ấy rất già.",
        "translation": "他（老先生）很老。",
        "options": [
            "Ông ấy rất giả.",
            "Ông ấy rất giàu.",
            "Ông ẩy rất già.",
            "Ông ấy rất già."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 64.02525,
        "end": 66.00525,
        "correctAnswer": "Bà ấy có trẻ không?",
        "translation": "她（老太太）年轻吗？",
        "options": [
            "Bà ấy có trể không?",
            "Bà ẩy có trẻ khôn?",
            "Bà ấy có chẻ không?",
            "Bà ấy có trẻ không?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 66.87525,
        "end": 68.74525,
        "correctAnswer": "Bà ấy trẻ lắm.",
        "translation": "她（老太太）非常年轻。",
        "options": [
            "Bà ấy trẻ lẳm.",
            "Bà ấy chẻ lắm.",
            "Bà ẩy trẻ lắm.",
            "Bà ấy trẻ lắm."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 69.49525,
        "end": 71.14525,
        "correctAnswer": "Bạn có khỏe không?",
        "translation": "你身体好吗？",
        "options": [
            "Bạn có khoẻ không?",
            "Bạn có khỏe khôn?",
            "Bạn cỏ khỏe không?",
            "Bạn có khỏe không?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 71.72525,
        "end": 73.11525,
        "correctAnswer": "Mình rất khỏe.",
        "translation": "我身体很好。",
        "options": [
            "Mình rát khỏe.",
            "Mình rất khoẻ.",
            "Mình rất khõe.",
            "Mình rất khỏe."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 74.00525,
        "end": 75.47525,
        "correctAnswer": "Chị ấy thế nào?",
        "translation": "(阿)姐怎么样？",
        "options": [
            "Chị ẩy thế nào?",
            "Chị ấy thề nào?",
            "Chị ấy thế náo?",
            "Chị ấy thế nào?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 76.36525,
        "end": 78.33525,
        "correctAnswer": "Chị ấy hơi yếu đấy.",
        "translation": "(阿)姐有点虚弱。",
        "options": [
            "Chị ấy hơi yểu đấy.",
            "Chị ẩy hơi yếu đấy.",
            "Chị ấy hởi yếu đấy.",
            "Chị ấy hơi yếu đấy."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 79.12525,
        "end": 80.71525,
        "correctAnswer": "Anh ấy thế nào.",
        "translation": "他怎么样。",
        "options": [
            "Anh ấy thế nào?",
            "Anh ẩy thế nào.",
            "Anh ấy thề nào.",
            "Anh ấy thế nào."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 81.27525,
        "end": 82.88525,
        "correctAnswer": "Anh ấy rất nhanh.",
        "translation": "他很快。",
        "options": [
            "Anh ấy rất nhành.",
            "Anh ẩy rất nhanh.",
            "Anh ấy rát nhanh.",
            "Anh ấy rất nhanh."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 83.55525,
        "end": 85.06525,
        "correctAnswer": "Ông ấy thế nào?",
        "translation": "他（老先生）怎么样？",
        "options": [
            "Ông ấy thề nào?",
            "Ông ấy thế náo?",
            "Ông ẩy thế nào?",
            "Ông ấy thế nào?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 85.73525,
        "end": 87.11525,
        "correctAnswer": "Ông ấy rất chậm.",
        "translation": "他（老先生）很慢。",
        "options": [
            "Ông ấy rất chẳm.",
            "Ông ẩy rất chậm.",
            "Ông ấy rát chậm.",
            "Ông ấy rất chậm."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 87.90525,
        "end": 89.91525,
        "correctAnswer": "Cậu ấy có cao không?",
        "translation": "他高吗？（朋友）",
        "options": [
            "Cậu ấy có cào không?",
            "Cậu ấy cố cao không?",
            "Cậu ẩy có cao không?",
            "Cậu ấy có cao không?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 90.49525,
        "end": 92.19525,
        "correctAnswer": "Cậu ấy cao lắm.",
        "translation": "他非常高。",
        "options": [
            "Cậu ấy cao lẳm.",
            "Cậu ẩy cao lắm.",
            "Cẩu ấy cao lắm.",
            "Cậu ấy cao lắm."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 92.95525,
        "end": 94.68525,
        "correctAnswer": "Bà ấy thế nào?",
        "translation": "她（老太太）怎么样？",
        "options": [
            "Bà ấy thề nào?",
            "Bà ẩy thế nào?",
            "Bà ấy thế náo?",
            "Bà ấy thế nào?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 95.24525,
        "end": 96.85525,
        "correctAnswer": "Bà ấy hơi thấp.",
        "translation": "她（老太太）有点矮。",
        "options": [
            "Bà ẩy hơi thấp.",
            "Bà ấy hởi thấp.",
            "Bà ấy hơi thắp.",
            "Bà ấy hơi thấp."
        ]
    }
];

        let currentIndex = 0;
        let isFreeMode = true;
        let correctCount = 0;
        let isPlaying = false;
        let correctSentences = new Set();
        let wrongSentences = new Set();
        let autoContinue = false;
        let showAnswer = false;
        let userAnswers = [];

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function init() {
            updateSentenceDisplay();
        }

        function updateSentenceDisplay() {
            sentenceNumber.value = currentIndex + 1;
            indicator.style.background = '#ffffe0';
            if (isFreeMode && showAnswer) {
                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #85ae5f;">${sentences[currentIndex].translation}</div>
                `;
            } else {
                indicator.innerHTML = '';
            }
            updateOptions();
            if (!isFreeMode) updateScore();
        }

        function updateOptions() {
            optionsContainer.innerHTML = '';
            const shuffledOptions = shuffleArray(sentences[currentIndex].options);
            shuffledOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'optionBtn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(btn);
            });
        }

        function playCurrentSentence() {
            if (isPlaying) audio.pause();
            buttons.forEach(btn => btn.classList.add('disabled'));
            sentenceNumber.disabled = true;
            isPlaying = true;
            audio.src = sentences[currentIndex].audioFile;
            audio.currentTime = sentences[currentIndex].start;
            audio.play().catch(error => {
                console.error('Audio playback failed:', error);
                alert('Vui lòng nhấn nút “再听一遍” để phát âm thanh.');
                buttons.forEach(btn => btn.classList.remove('disabled'));
                sentenceNumber.disabled = false;
                isPlaying = false;
            });

            audio.ontimeupdate = () => {
                if (audio.currentTime >= sentences[currentIndex].end) {
                    audio.pause();
                    audio.ontimeupdate = null;
                    buttons.forEach(btn => btn.classList.remove('disabled'));
                    sentenceNumber.disabled = false;
                    isPlaying = false;
                }
            };
        }

        function moveSentence(direction) {
            currentIndex = (currentIndex + direction + sentences.length) % sentences.length;
            updateSentenceDisplay();
            playCurrentSentence();
        }

        function checkAnswer(selectedAnswer) {
            const correctAnswer = sentences[currentIndex].correctAnswer;
            const optionButtons = optionsContainer.getElementsByClassName('optionBtn');
            
            // Clear previous styles
            for (let btn of optionButtons) {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = !isFreeMode; // Only disable buttons in Test Mode
            }

            // Find and style the selected button
            for (let btn of optionButtons) {
                if (btn.textContent === selectedAnswer) {
                    if (selectedAnswer === correctAnswer) {
                        indicator.style.background = '#B7D7AA';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('correct');
                        correctAudio.play().catch(error => {
                            console.error('Correct audio playback failed:', error);
                        });
                    } else {
                        indicator.style.background = '#CE6D5E';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('wrong');
                        wrongAudio.play().catch(error => {
                            console.error('Wrong audio playback failed:', error);
                        });
                    }
                }
            }

            if (!isFreeMode) {
                userAnswers[currentIndex] = selectedAnswer;
                if (selectedAnswer === correctAnswer && !correctSentences.has(currentIndex)) {
                    correctCount++;
                    correctSentences.add(currentIndex);
                    wrongSentences.delete(currentIndex);
                } else if (selectedAnswer !== correctAnswer && !correctSentences.has(currentIndex)) {
                    wrongSentences.add(currentIndex);
                }
                updateScore();

                // Auto-move to next sentence in Test Mode
                const audioToWait = (selectedAnswer === correctAnswer) ? correctAudio : wrongAudio;
                audioToWait.onended = () => {
                    if (userAnswers.length === sentences.length) {
                        showResults();
                    } else {
                        setTimeout(() => {
                            moveSentence(1);
                        }, 200);
                    }
                };
            } else if (isFreeMode && autoContinue && selectedAnswer === correctAnswer) {
                // Auto-move in Free Mode only if answer is correct and autoContinue is enabled
                correctAudio.onended = () => {
                    setTimeout(() => {
                        moveSentence(1);
                    }, 200);
                };
            } else {
                correctAudio.onended = null;
                wrongAudio.onended = null;
            }
        }

        function updateScore() {
            scoreDisplay.textContent = `${correctCount}/${sentences.length}`;
            scoreDisplay.style.display = 'block'; // Hiển thị score trong Test Mode
        }

        function showResults() {
            let resultText = `练习完成！\n正确答案数量：${correctCount}/${sentences.length}\n正确率：${((correctCount / sentences.length) * 100).toFixed(2)}%\n错误题目：`;
            wrongSentences.forEach(index => {
                resultText += `\n第${index + 1}题：\n你的选择：${userAnswers[index] || '未选择'}\n正确答案：${sentences[index].correctAnswer}\n`;
            });
            if (wrongSentences.size === 0) {
                resultText += '\n全部正确！';
            }
            resultsDisplay.textContent = resultText;
            resultsDisplay.style.display = 'block';
        }

        prevBtn.onclick = () => {
            moveSentence(-1);
        };

        nextBtn.onclick = () => {
            moveSentence(1);
        };

        replayBtn.onclick = () => {
            playCurrentSentence();
        };

        freeModeBtn.onclick = () => {
            isFreeMode = true;
            freeModeBtn.classList.add('active-mode');
            testModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = false;
            autoContinueBtn.classList.remove('disabled');
            showHideBtn.disabled = false;
            showHideBtn.classList.remove('disabled');
            scoreDisplay.style.display = 'none';
            wrongSentencesDisplay.style.display = 'none';
            resultsDisplay.style.display = 'none';
            updateSentenceDisplay();
        };

        testModeBtn.onclick = () => {
            isFreeMode = false;
            testModeBtn.classList.add('active-mode');
            freeModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = true;
            autoContinueBtn.classList.add('disabled');
            showHideBtn.disabled = true;
            showHideBtn.classList.add('disabled');
            showHideBtn.classList.remove('active-mode');
            showAnswer = false;
            scoreDisplay.style.display = 'block';
            currentIndex = 0;
            correctCount = 0;
            correctSentences.clear();
            wrongSentences.clear();
            userAnswers = [];
            for (let i = 0; i < sentences.length; i++) {
                wrongSentences.add(i);
            }
            updateSentenceDisplay();
        };

        autoContinueBtn.onclick = () => {
            if (isFreeMode) {
                autoContinue = !autoContinue;
                autoContinueBtn.classList.toggle('active-mode');
                if (!autoContinue) {
                    correctAudio.onended = null;
                }
            }
        };

        showHideBtn.onclick = () => {
            if (isFreeMode) {
                showAnswer = !showAnswer;
                showHideBtn.classList.toggle('active-mode');
                updateSentenceDisplay();
            }
        };

        sentenceNumber.onchange = () => {
            if (!isPlaying) {
                const num = parseInt(sentenceNumber.value) - 1;
                if (!isNaN(num) && num >= 0 && num < sentences.length) {
                    currentIndex = num;
                    updateSentenceDisplay();
                    playCurrentSentence();
                } else {
                    alert(`输入范围： 1 到 ${sentences.length}`);
                    updateSentenceDisplay();
                }
            }
        };

        sentenceNumber.onkeydown = (e) => {
            if (!isPlaying) {
                if (e.key === 'ArrowLeft') {
                    moveSentence(-1);
                }
                if (e.key === 'ArrowRight') {
                    moveSentence(1);
                }
            }
        };

        init();
    </script>
</body>
</html>